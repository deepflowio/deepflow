variables:
  GIT_SUBMODULE_STRATEGY: recursive
  BUILD_IMAGE: docker-hosted.nexus.yunshan.net/rust-build:0.4
  NEXUS_REGISTRY: docker-hosted.nexus.yunshan.net
  DEPLOY_IMAGE: docker-hosted.nexus.yunshan.net/metaflow-agent

stages:
  - package-rust
  - verify
  - package

verify-x64:
  stage: verify
  tags:
    - x64
  script:
    - cargo build
    - cargo build --bin metaflow-agent-ctl
    - cargo test
    - cargo fmt --all -- --check
    - cargo clean

package-rust:
  stage: package-rust
  tags:
    - docker
  before_script:
    - docker login -u admin -p metaflow $NEXUS_REGISTRY
  script:
    - cd docker
    - docker build --pull -t $BUILD_IMAGE -f Dockerfile.build .
    - docker push $BUILD_IMAGE
    - echo "Pushed $BUILD_IMAGE"
    - docker image rm $BUILD_IMAGE
  only:
    - package-rust

package-x64:
  stage: package
  tags:
    - x64
  script:
    - rpmbuild -bb metaflow-agent.spec -D '_rpmdir .' --buildroot $(pwd)/.rpmbuild
    - zip -r -q artifacts.zip x86_64/
    - curl -v --user 'admin:metaflow' --upload-file artifacts.zip http://nexus.yunshan.net/repository/platform/trident-rs/$CI_COMMIT_REF_NAME/x86_64/artifacts.zip
    - REV=$(git rev-list --count HEAD)
    - curl -v --user 'admin:metaflow' --upload-file artifacts.zip http://nexus.yunshan.net/repository/platform/trident-rs/$CI_COMMIT_REF_NAME/x86_64/artifacts_${REV}.z
    - cp target/release/metaflow-agent docker/
    - cp target/release/metaflow-agent-ctl docker/
    - cp src/ebpf/metaflow-ebpfctl docker/
    - cp -r src/ebpf/data docker/
    - cd docker
    - ls
    - RELEASE=$(echo ${CI_COMMIT_REF_NAME//B_LC_RELEASE_} | tr '_' '.' | sed 's/master/latest/')
    - REV=$(git rev-list --count HEAD)
    # e.g. metaflow-agnet:latest
    - docker build --pull -t  $DEPLOY_IMAGE:$RELEASE .
    - docker push $DEPLOY_IMAGE:$RELEASE
    # e.g. metaflow-agnet:latest.50
    - docker build --pull -t  $DEPLOY_IMAGE:$RELEASE.$REV .
    - docker push $DEPLOY_IMAGE:$RELEASE.$REV
    - cargo clean

  only:
    - master
    - /B_LC_RELEASE_.*/
    - /feature-.*/
  artifacts:
      paths:
        - x86_64/metaflow*.rpm
# 部分docker环境没有安装cargo命令，这里先注释掉
#package-docker:
#  stage: package
#  tags:
#    - docker
#  before_script:
#    - docker login -u admin -p metaflow $NEXUS_REGISTRY
#  script:
#    - cargo build --release
#    - cargo build --release --bin metaflow-agent-ctl
#    - cp target/release/metaflow-agent docker/
#    - cp target/release/metaflow-agent-ctl docker/
#    - cp src/ebpf/metaflow-ebpfctl docker/
#    - cp -r src/ebpf/data docker/
#    - cd docker
#    - ls
#    - RELEASE=$(echo ${CI_COMMIT_REF_NAME//B_LC_RELEASE_} | tr '_' '.' | sed 's/master/latest/')
#    - REV=$(git rev-list --count HEAD)
#    # e.g. metaflow-agnet:latest
#    - docker build --pull -t  $DEPLOY_IMAGE:$RELEASE .
#    - docker push $DEPLOY_IMAGE:$RELEASE
#    # e.g. metaflow-agnet:latest.50
#    - docker build --pull -t  $DEPLOY_IMAGE:$RELEASE.$REV .
#    - docker push $DEPLOY_IMAGE:$RELEASE.$REV
#  only:
#    - master
#    - /B_LC_RELEASE_.*/
#    - /feature-.*/
